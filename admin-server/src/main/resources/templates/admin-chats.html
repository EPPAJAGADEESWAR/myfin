<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MyFin – Admin Chats</title>
<link rel="stylesheet" href="/style.css">
<style>
.layout {
	display: grid;
	grid-template-columns: 260px 1fr;
	gap: 16px;
}

.customer-list {
	border: 1px solid #e5e7eb;
	border-radius: 8px;
	max-height: 340px;
	overflow-y: auto;
}

.customer-item {
	padding: 8px 12px;
	cursor: pointer;
	border-bottom: 1px solid #e5e7eb;
}

.customer-item.active {
	background: #e5f2ff;
}

.chat-box {
	height: 320px;
	border: 1px solid #e5e7eb;
	border-radius: 8px;
	padding: 8px;
	overflow-y: auto;
	background: #f9fafb;
}

.msg {
	margin: 4px 0;
	padding: 6px 10px;
	border-radius: 12px;
	max-width: 70%;
	font-size: 14px;
}

.msg.admin {
	background: #2563eb;
	color: white;
	margin-left: auto;
}

.msg.customer {
	background: #e5e7eb;
	color: #111827;
	margin-right: auto;
}

.msg time {
	display: block;
	font-size: 11px;
	opacity: 0.8;
}
</style>
</head>
<body class="landing-body">

	<div class="landing-wrapper wide-card">

		<div class="top-right-logout">
			<button id="backBtn" class="logout-btn">Back</button>
		</div>

		<header class="landing-header">
			<div class="logo-circle">MF</div>
			<div>
				<h1 class="bank-name">Customer chats</h1>
				<p class="tagline">Reply to customer queries</p>
			</div>
		</header>

		<main>
			<div id="msg" class="message"></div>

			<section class="summary-card" style="margin-top: 12px;">
				<div class="layout">
					<!-- Left: customers -->
					<div>
						<h3>Customers</h3>
						<div id="customersList" class="customer-list">Loading
							customers...</div>
					</div>

					<!-- Right: conversation -->
					<div>
						<h3 id="chatTitle">Conversation</h3>
						<div id="chatBox" class="chat-box"></div>

						<form id="replyForm" class="form-inline" style="margin-top: 8px;">
							<input type="text" id="replyInput" style="flex: 1;"
								placeholder="Type reply..." required>
							<button type="submit" class="btn primary"
								style="margin-left: 8px;">Send</button>
						</form>
					</div>
				</div>
			</section>
		</main>
	</div>

	<script>
    const customerBaseUrl = 'http://localhost:8081';

    const msg = document.getElementById('msg');
    const customersList = document.getElementById('customersList');
    const chatBox = document.getElementById('chatBox');
    const chatTitle = document.getElementById('chatTitle');
    const replyForm = document.getElementById('replyForm');
    const replyInput = document.getElementById('replyInput');

    let selectedCustomerId = null;

    function showMessage(text, isError = false) {
        msg.textContent = text;
        msg.style.color = isError ? 'red' : '#374151';
    }

    document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = '/admin/dashboard';
    });

    // Load customers who have chats
    async function loadCustomers() {
        try {
            const res = await fetch(customerBaseUrl + '/admin-api/customers');
            if (!res.ok) {
                customersList.textContent = 'Failed to load customers.';
                return;
            }
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) {
                customersList.textContent = 'No customer chats yet.';
                return;
            }
            customersList.innerHTML = '';
            for (const c of data) {
                const div = document.createElement('div');
                div.className = 'customer-item';
                div.dataset.id = c.customerId;
                div.textContent = `${c.name} (#${c.customerId})`;
                customersList.appendChild(div);
            }
        } catch (e) {
            customersList.textContent = 'Error loading customers.';
        }
    }

    function renderMessages(list) {
        chatBox.innerHTML = '';
        for (const m of list) {
            const div = document.createElement('div');
            div.className = 'msg ' + (m.fromRole === 'ADMIN' ? 'admin' : 'customer');
            const time = m.createdAt ? m.createdAt.replace('T',' ').substring(0,16) : '';
            div.innerHTML = `
                <div>${m.message}</div>
                <time>${m.fromRole} • ${time}</time>
            `;
            chatBox.appendChild(div);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function loadConversation(customerId) {
        try {
            const res = await fetch(customerBaseUrl + `/admin-api/chats?customerId=${customerId}`);
            if (!res.ok) {
                showMessage('Failed to load chat: ' + res.status, true);
                return;
            }
            const data = await res.json();
            renderMessages(data);
        } catch (e) {
            showMessage('Error loading chat: ' + e, true);
        }
    }

    customersList.addEventListener('click', (e) => {
        const item = e.target.closest('.customer-item');
        if (!item) return;
        selectedCustomerId = item.dataset.id;

        document.querySelectorAll('.customer-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');

        chatTitle.textContent = `Conversation with customer #${selectedCustomerId}`;
        loadConversation(selectedCustomerId);
    });

    replyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedCustomerId) {
            showMessage('Select a customer first.', true);
            return;
        }
        const text = replyInput.value.trim();
        if (!text) return;

        try {
            const res = await fetch(
                customerBaseUrl + `/admin-api/chats/reply?customerId=${selectedCustomerId}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: text
                }
            );
            if (!res.ok) {
                showMessage('Failed to send reply: ' + res.status, true);
                return;
            }
            replyInput.value = '';
            await loadConversation(selectedCustomerId);
        } catch (err) {
            showMessage('Error sending reply: ' + err, true);
        }
    });

    setInterval(() => {
        if (selectedCustomerId) {
            loadConversation(selectedCustomerId);
        }
    }, 5000);

    loadCustomers();
</script>


</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MyFin – Support Chat</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        .chat-box {
            height: 320px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            overflow-y: auto;
            background: #f9fafb;
        }

        .msg {
            margin: 4px 0;
            padding: 6px 10px;
            border-radius: 12px;
            max-width: 70%;
            font-size: 14px;
        }

        .msg.me {
            background: #2563eb;
            color: white;
            margin-left: auto;
        }

        .msg.admin {
            background: #e5e7eb;
            color: #111827;
            margin-right: auto;
        }

        .msg time {
            display: block;
            font-size: 11px;
            opacity: 0.8;
        }
    </style>
</head>
<body class="landing-body">

<div class="landing-wrapper wide-card">

    <!-- back button -->
    <div class="top-right-logout">
        <button id="backBtn" class="logout-btn">Back</button>
    </div>

    <header class="landing-header">
        <div class="logo-circle">MF</div>
        <div>
            <h1 class="bank-name">Support chat</h1>
            <p class="tagline">Chat with MyFin admin for help</p>
        </div>
    </header>

    <main>
        <div id="msg" class="message"></div>

        <section class="summary-card" style="margin-top: 12px;">
            <h3>Conversation</h3>
            <div id="chatBox" class="chat-box"></div>

            <form id="chatForm" class="form-inline" style="margin-top: 8px;">
                <input type="text" id="chatInput" style="flex: 1;"
                       placeholder="Type your message..." required>
                <button type="submit" class="btn primary" style="margin-left: 8px;">Send</button>
            </form>
        </section>
    </main>
</div>

<script>
    const baseUrl = 'http://localhost:8081';
    const msg = document.getElementById('msg');
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            window.location.href = '/customer/accounts';
        });
    }

    function showMessage(text, isError = false) {
        msg.textContent = text;
        msg.style.color = isError ? 'red' : '#374151';
    }

    function getToken() {
        return localStorage.getItem('jwtToken');
    }

    function renderMessages(list) {
        chatBox.innerHTML = '';
        for (const m of list) {
            const div = document.createElement('div');
            const mine = m.fromRole === 'CUSTOMER';
            div.className = 'msg ' + (mine ? 'me' : 'admin');
            const time = m.createdAt ? m.createdAt.replace('T', ' ').substring(0, 16) : '';
            div.innerHTML = `
                <div>${m.message}</div>
                <time>${m.fromRole} • ${time}</time>
            `;
            chatBox.appendChild(div);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function loadChat() {
        const token = getToken();
        if (!token) {
            showMessage('Please login again.', true);
            return;
        }
        try {
            const res = await fetch(baseUrl + '/chats', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            if (!res.ok) {
                showMessage('Failed to load chat: ' + res.status, true);
                return;
            }
            const data = await res.json();
            renderMessages(data);
        } catch (e) {
            showMessage('Error loading chat: ' + e, true);
        }
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = chatInput.value.trim();
        if (!text) return;

        const token = getToken();
        if (!token) {
            showMessage('Please login again.', true);
            return;
        }

        try {
            const res = await fetch(baseUrl + '/chats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                    'Authorization': 'Bearer ' + token
                },
                body: text
            });
            if (!res.ok) {
                showMessage('Failed to send message: ' + res.status, true);
                return;
            }
            chatInput.value = '';
            await loadChat();
        } catch (err) {
            showMessage('Error sending message: ' + err, true);
        }
    });

    setInterval(loadChat, 5000);
    loadChat();
</script>

</body>
</html>
